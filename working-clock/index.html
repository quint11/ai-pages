<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkingClock - å®æ—¶å·¥èµ„è®¡ç®—å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script> --> <!-- REMOVED date-fns -->
    <style>
        /* CSS ä¿æŒä¸å˜ */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #50e3c2;
            --background-color: #f4f7f6;
            --text-color: #333;
            --card-background: #ffffff;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --gradient-start: #6dd5ed;
            --gradient-end: #2193b0;
        }

        .dark-mode {
            --primary-color: #58a6ff;
            --secondary-color: #39d3bb;
            --background-color: #1c2128;
            --text-color: #c9d1d9;
            --card-background: #2d333b;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            --border-color: #444c56;
            --gradient-start: #0f2027;
            --gradient-end: #203a43;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        header, footer {
            padding: 15px 0;
            text-align: center;
        }
        
        header {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        main {
            flex-grow: 1;
        }

        /* Components */
        .card {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .card-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title .small-text {
            font-size: 0.6em;
            color: var(--text-color);
            opacity: 0.7;
        }

        .current-time {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .salary-display {
            text-align: center;
        }

        .salary-display .amount {
            font-size: 3.5em;
            font-weight: bold;
            color: var(--primary-color);
            letter-spacing: 1px;
            padding: 10px 0;
            display: inline-block;
            min-width: 200px; /* For smoother animation */
        }

        .salary-display .label {
            font-size: 1.1em;
            color: var(--text-color);
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .salary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-item .value {
            font-size: 2em;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .stat-item .label {
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px 0;
        }

        button, .button-like {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover, .button-like:hover {
            background-color: #3a7bc8; /* Darken primary */
            transform: translateY(-1px);
        }
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #40c3a2; /* Darken secondary */
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .input-group {
            margin-bottom: 18px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1em;
        }
        .input-group input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .input-group .input-hint {
            font-size: 0.85em;
            color: var(--text-color);
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Modal for Settings */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: var(--card-background);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        .modal-close {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover {
            opacity: 0.7;
        }
        
        /* Raise Plan specific styles */
        .raise-plan-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .raise-plan-item input {
            flex-grow: 1;
        }

        /* Fullscreen mode */
        .fullscreen-active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .fullscreen-active .salary-display .amount {
            font-size: 10vw; /* Responsive font size */
        }
        .fullscreen-active .salary-display .label {
            font-size: 3vw;
        }
        .fullscreen-active .current-time {
            font-size: 4vw;
        }
        .fullscreen-exit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5em;
        }

        /* Utility */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .hidden { display: none !important; }

        /* Chart container responsiveness */
        .chart-container {
            position: relative;
            height: 350px; /* Default height */
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .salary-display .amount { font-size: 2.5em; }
            .card-title { font-size: 1.5em; }
            .controls { flex-direction: column; }
            button, .button-like { width: 100%; }
            .modal-content { margin: 20% auto; width: 95%; }
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <header>
            <h1 style="color: var(--primary-color);">WorkingClock å®æ—¶å·¥èµ„è®¡ç®—å™¨</h1>
            <div id="currentTimeDisplay" class="current-time">--:--:--</div>
        </header>

        <main>
            <!-- Real-time Salary Section -->
            <div class="card">
                <div class="card-title">
                    <span>ğŸ’° å®æ—¶å·¥èµ„</span>
                    <button id="fullscreenBtn" class="button-like" style="font-size:0.8em; padding: 8px 15px;">å…¨å±</button>
                </div>
                <div class="salary-display">
                    <span id="realTimeSalaryAmount" class="amount">0.00</span>
                    <div id="realTimeSalaryLabel" class="label">ä»Šæ—¥å·²èµš</div>
                </div>
                <div class="controls">
                    <button data-period="today">ä»Šæ—¥</button>
                    <button data-period="week">æœ¬å‘¨</button>
                    <button data-period="month">æœ¬æœˆ</button>
                    <button data-period="total">ç´¯è®¡</button>
                </div>
            </div>
            
            <!-- Income Overview -->
            <div class="card">
                <div class="card-title">ğŸ“Š æ”¶å…¥æ€»è§ˆ</div>
                <p id="encouragementText" class="mb-2 text-center" style="font-size: 1.1em; color: var(--success-color);"></p>
                <div class="salary-grid">
                    <div class="stat-item">
                        <span id="totalEarned" class="value">0.00</span>
                        <span class="label">ç´¯è®¡å·²èµš (å…ƒ)</span>
                    </div>
                    <div class="stat-item">
                        <span id="workDaysTotal" class="value">0</span>
                        <span class="label">ç´¯è®¡æ‰“å·¥å¤©æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span id="avgDailyIncome" class="value">0.00</span>
                        <span class="label">å¹³å‡æ—¥æ”¶å…¥ (å…ƒ)</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="card">
                <div class="card-title">ğŸ“ˆ æ”¶ç›Šå›¾è¡¨</div>
                <div class="controls mb-2">
                    <label for="chartTypeSelect">å›¾è¡¨ç±»å‹:</label>
                    <select id="chartTypeSelect" class="input-group input" style="padding:10px; border-radius: 6px;">
                        <option value="history">å†å²æ”¶ç›Šæ›²çº¿</option>
                        <option value="future">æœªæ¥æ”¶ç›Šé¢„ä¼°</option>
                    </select>
                    <label for="chartRangeSelect" id="chartRangeLabel">æ—¶é—´èŒƒå›´:</label>
                    <select id="chartRangeSelect" class="input-group input" style="padding:10px; border-radius: 6px;">
                        <option value="7">è¿‘7å¤©</option>
                        <option value="30">è¿‘30å¤©</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="year">ä»Šå¹´</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>

        </main>

        <footer>
            <div class="controls">
                <button id="settingsBtn">âš™ï¸ è®¾ç½®</button>
                <button id="toggleTaxBtn">ç¨å‰</button>
                <button id="toggleThemeBtn">ğŸŒ™ å¤œé—´æ¨¡å¼</button>
                <button id="exportCsvBtn">ğŸ“Š å¯¼å‡ºCSV</button>
            </div>
            <p style="font-size: 0.9em; opacity: 0.7;">Â© <span id="currentYear"></span> WorkingClock. Crafted with â¤ï¸ for all hard workers.</p>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modalCloseBtn">Ã—</span>
            <h2>åŸºæœ¬è®¾ç½®</h2>
            <div class="input-group">
                <label for="joinDate">å…¥èŒæ—¥æœŸ:</label>
                <input type="date" id="joinDate">
            </div>
            <div class="input-group">
                <label for="monthlySalary">æœˆå·¥èµ„ (ç¨å‰): 
                    <span id="showSalaryToggle" style="cursor:pointer; font-weight:normal;">ğŸ‘ï¸</span>
                </label>
                <input type="number" id="monthlySalary" placeholder="ä¾‹å¦‚: 12000">
            </div>
            <div class="input-group">
                <label for="workDaysPerMonth">æ¯æœˆå·¥ä½œå¤©æ•°:</label>
                <input type="number" id="workDaysPerMonth" placeholder="ä¾‹å¦‚: 22">
            </div>
            <div class="input-group">
                <label for="workHoursPerDay">æ¯æ—¥å·¥ä½œå°æ—¶:</label>
                <input type="number" id="workHoursPerDay" placeholder="ä¾‹å¦‚: 8">
            </div>

            <h2>ç¨åŠ¡è®¾ç½®</h2>
            <div class="input-group">
                <label for="insuranceRate">äº”é™©ä¸€é‡‘æ¯”ä¾‹ (%):</label>
                <input type="number" id="insuranceRate" step="0.1" placeholder="ä¾‹å¦‚: 10.5 (å³10.5%)">
                <div class="input-hint">è¾“å…¥å¦‚ 10.5 ä»£è¡¨ 10.5%</div>
            </div>
            <div class="input-group">
                <label for="taxRate">ä¸ªäººæ‰€å¾—ç¨ç»¼åˆç¨ç‡ (%):</label>
                <input type="number" id="taxRate" step="0.1" placeholder="ä¾‹å¦‚: 5 (å³5%)">
                <div class="input-hint">è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç»¼åˆç¨ç‡ï¼Œå®é™…ä¸ªç¨è®¡ç®—å¤æ‚ã€‚</div>
            </div>
            
            <h2>æ¶¨è–ªè®¡åˆ’</h2>
            <div id="raisePlanContainer">
                <!-- Raise plan items will be added here by JS -->
            </div>
            <button id="addRaisePlanBtn" class="secondary mt-1">âœš æ·»åŠ æ¶¨è–ªè®¡åˆ’</button>

            <button id="saveSettingsBtn" class="mt-2" style="width:100%;">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>
    
    <!-- Fullscreen Display Area -->
    <div id="fullscreenDisplay" class="fullscreen-active hidden">
        <button id="fullscreenExitBtn" class="button-like fullscreen-exit-btn">Ã— é€€å‡ºå…¨å±</button>
        <div id="fullscreenCurrentTime" class="current-time">--:--:--</div>
        <div class="salary-display">
            <span id="fullscreenSalaryAmount" class="amount">0.00</span>
            <div id="fullscreenSalaryLabel" class="label">ä»Šæ—¥å·²èµš</div>
        </div>
    </div>

    <script>
        // --- Native Date Helper Functions ---
        const DateHelpers = {
            formatToYMD: (date) => {
                if (!DateHelpers.isValid(date)) return '';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            formatToHMS: (date) => {
                if (!DateHelpers.isValid(date)) return '';
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            },
            formatToMMDD: (date) => {
                if (!DateHelpers.isValid(date)) return '';
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}/${day}`;
            },
            parseISO: (dateString) => { // Handles YYYY-MM-DD and YYYY-MM-DDTHH:mm:ss.sssZ
                if (!dateString) return new Date(NaN); // Invalid date
                // For 'YYYY-MM-DD', new Date() often works but can be timezone-sensitive.
                // To be more robust for YYYY-MM-DD and treat it as local midnight:
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = dateString.split('-');
                    // Month is 0-indexed in new Date()
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                return new Date(dateString); // For full ISO strings
            },
            isValid: (date) => date instanceof Date && !isNaN(date.getTime()),
            differenceInSeconds: (dateLeft, dateRight) => {
                if (!DateHelpers.isValid(dateLeft) || !DateHelpers.isValid(dateRight)) return 0;
                return Math.round((dateLeft.getTime() - dateRight.getTime()) / 1000);
            },
            differenceInCalendarDays: (dateLeft, dateRight) => {
                if (!DateHelpers.isValid(dateLeft) || !DateHelpers.isValid(dateRight)) return 0;
                const dL = new Date(dateLeft.getFullYear(), dateLeft.getMonth(), dateLeft.getDate());
                const dR = new Date(dateRight.getFullYear(), dateRight.getMonth(), dateRight.getDate());
                return Math.round((dL.getTime() - dR.getTime()) / (1000 * 60 * 60 * 24));
            },
            startOfToday: () => new Date(new Date().setHours(0, 0, 0, 0)),
            startOfWeek: (date, weekStartsOnMonday = true) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                const d = new Date(date);
                const day = d.getDay(); // Sunday = 0, Monday = 1, ...
                const diff = weekStartsOnMonday ?
                             (day === 0 ? -6 : 1 - day) :
                             (0 - day); // if Sunday is start
                d.setDate(d.getDate() + diff);
                d.setHours(0, 0, 0, 0);
                return d;
            },
            startOfMonth: (date) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                return new Date(date.getFullYear(), date.getMonth(), 1, 0, 0, 0, 0);
            },
            startOfYear: (date) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                return new Date(date.getFullYear(), 0, 1, 0, 0, 0, 0);
            },
            endOfDay: (date) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                return new Date(new Date(date).setHours(23, 59, 59, 999));
            },
            addMonths: (date, amount) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                const d = new Date(date);
                d.setMonth(d.getMonth() + amount);
                return d;
            },
            addYears: (date, amount) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                const d = new Date(date);
                d.setFullYear(d.getFullYear() + amount);
                return d;
            },
            addDays: (date, amount) => {
                if (!DateHelpers.isValid(date)) return new Date(NaN);
                const d = new Date(date);
                d.setDate(d.getDate() + amount);
                return d;
            },
            subDays: (date, amount) => DateHelpers.addDays(date, -amount),
            isBefore: (date1, date2) => DateHelpers.isValid(date1) && DateHelpers.isValid(date2) && date1.getTime() < date2.getTime(),
            isAfter: (date1, date2) => DateHelpers.isValid(date1) && DateHelpers.isValid(date2) && date1.getTime() > date2.getTime(),
            isEqual: (date1, date2) => DateHelpers.isValid(date1) && DateHelpers.isValid(date2) && date1.getTime() === date2.getTime(),
            isSameDay: (date1, date2) => { // Checks if two dates are on the same calendar day
                 if (!DateHelpers.isValid(date1) || !DateHelpers.isValid(date2)) return false;
                 return date1.getFullYear() === date2.getFullYear() &&
                        date1.getMonth() === date2.getMonth() &&
                        date1.getDate() === date2.getDate();
            }
        };
        // --- End of Native Date Helper Functions ---


        const LS_CONFIG_KEY = 'workingClockConfig';
        const LS_RECORDS_KEY = 'workingClockRecords';

        let appState = {
            config: {
                monthlySalary: 0,
                workDaysPerMonth: 22,
                workHoursPerDay: 8,
                isAfterTax: false,
                taxConfig: {
                    insuranceRate: 0.105,
                    taxRate: 0.03
                },
                joinDate: DateHelpers.formatToYMD(new Date()), // MODIFIED
                raisePlan: []
            },
            incomeRecords: [],
            realTimeInterval: null,
            incomeChartInstance: null,
            currentRealTimePeriod: 'today'
        };

        // DOM Elements
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const DOMElements = { /* ... DOMElements object remains the same ... */
            currentTimeDisplay: $('#currentTimeDisplay'),
            realTimeSalaryAmount: $('#realTimeSalaryAmount'),
            realTimeSalaryLabel: $('#realTimeSalaryLabel'),
            realTimePeriodButtons: $$('.controls button[data-period]'),
            fullscreenBtn: $('#fullscreenBtn'),
            fullscreenDisplay: $('#fullscreenDisplay'),
            fullscreenCurrentTime: $('#fullscreenCurrentTime'),
            fullscreenSalaryAmount: $('#fullscreenSalaryAmount'),
            fullscreenSalaryLabel: $('#fullscreenSalaryLabel'),
            fullscreenExitBtn: $('#fullscreenExitBtn'),
            
            totalEarned: $('#totalEarned'),
            workDaysTotal: $('#workDaysTotal'),
            avgDailyIncome: $('#avgDailyIncome'),
            encouragementText: $('#encouragementText'),
            
            incomeChartCanvas: $('#incomeChart'),
            chartTypeSelect: $('#chartTypeSelect'),
            chartRangeSelect: $('#chartRangeSelect'),
            chartRangeLabel: $('#chartRangeLabel'),

            settingsBtn: $('#settingsBtn'),
            toggleTaxBtn: $('#toggleTaxBtn'),
            toggleThemeBtn: $('#toggleThemeBtn'),
            exportCsvBtn: $('#exportCsvBtn'),
            
            settingsModal: $('#settingsModal'),
            modalCloseBtn: $('#modalCloseBtn'),
            joinDateInput: $('#joinDate'),
            monthlySalaryInput: $('#monthlySalary'),
            showSalaryToggle: $('#showSalaryToggle'),
            workDaysPerMonthInput: $('#workDaysPerMonth'),
            workHoursPerDayInput: $('#workHoursPerDay'),
            insuranceRateInput: $('#insuranceRate'),
            taxRateInput: $('#taxRate'),
            raisePlanContainer: $('#raisePlanContainer'),
            addRaisePlanBtn: $('#addRaisePlanBtn'),
            saveSettingsBtn: $('#saveSettingsBtn'),
            currentYear: $('#currentYear')
        };
        
        // Utility Functions (formatCurrency, animateNumber remain the same)
        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2);
        }

        function animateNumber(element, targetValue, duration = 500) {
            if (!element) return;
            const startValue = parseFloat(element.textContent.replace(/,/g, '')) || 0;
            const diff = targetValue - startValue;
            if (diff === 0) {
                element.textContent = formatCurrency(targetValue);
                return;
            }
            let startTime = null;

            function step(currentTime) {
                if (!startTime) startTime = currentTime;
                const progress = Math.min((currentTime - startTime) / duration, 1);
                const currentValue = startValue + diff * progress;
                element.textContent = formatCurrency(currentValue);
                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    element.textContent = formatCurrency(targetValue);
                }
            }
            requestAnimationFrame(step);
        }
        
        // Core Calculation Logic
        function getEffectiveMonthlySalary(date = new Date()) {
            let currentSalary = parseFloat(appState.config.monthlySalary) || 0;
            if (!appState.config.raisePlan || appState.config.raisePlan.length === 0) {
                return currentSalary;
            }

            const sortedRaisePlan = [...appState.config.raisePlan].sort((a, b) => 
                DateHelpers.differenceInCalendarDays(DateHelpers.parseISO(a.date), DateHelpers.parseISO(b.date)) // MODIFIED
            );

            for (const raise of sortedRaisePlan) {
                const raiseDate = DateHelpers.parseISO(raise.date); // MODIFIED
                if (DateHelpers.isValid(raiseDate) && (DateHelpers.isBefore(raiseDate, date) || DateHelpers.isEqual(raiseDate, date))) { // MODIFIED
                    currentSalary *= (1 + (parseFloat(raise.percentage) / 100));
                }
            }
            return currentSalary;
        }

        function calculateSalaryDetails(monthlySalaryInput) {
            // ... this function doesn't use date functions directly, remains the same
            const monthlySalary = monthlySalaryInput;
            const workDays = parseFloat(appState.config.workDaysPerMonth) || 22;
            const workHours = parseFloat(appState.config.workHoursPerDay) || 8;

            if (monthlySalary <= 0 || workDays <= 0 || workHours <= 0) {
                return { perSecond: 0, daily: 0, afterTaxMonthly: 0, taxAmount: 0 };
            }

            const dailyGross = monthlySalary / workDays;
            const hourlyGross = dailyGross / workHours;
            const perSecondGross = hourlyGross / 3600;

            let afterTaxMonthly = monthlySalary;
            let totalTaxAmount = 0;

            if (appState.config.isAfterTax) {
                const insuranceDeduction = monthlySalary * (parseFloat(appState.config.taxConfig.insuranceRate) || 0);
                const taxableIncome = monthlySalary - insuranceDeduction;
                const incomeTax = taxableIncome * (parseFloat(appState.config.taxConfig.taxRate) || 0); 
                totalTaxAmount = insuranceDeduction + incomeTax;
                afterTaxMonthly = monthlySalary - totalTaxAmount;
            }
            
            const dailyNet = afterTaxMonthly / workDays;
            const perSecondNet = (afterTaxMonthly / workDays / workHours) / 3600;

            return {
                perSecond: appState.config.isAfterTax ? perSecondNet : perSecondGross,
                daily: appState.config.isAfterTax ? dailyNet : dailyGross,
                monthly: appState.config.isAfterTax ? afterTaxMonthly : monthlySalary,
                taxAmount: totalTaxAmount
            };
        }

        // Real-time Update Logic
        function updateRealTimeClock() {
            const now = new Date();
            DOMElements.currentTimeDisplay.textContent = DateHelpers.formatToHMS(now); // MODIFIED
            if (DOMElements.fullscreenDisplay.classList.contains('hidden') === false) {
                 DOMElements.fullscreenCurrentTime.textContent = DateHelpers.formatToHMS(now); // MODIFIED
            }

            const joinDate = DateHelpers.parseISO(appState.config.joinDate); // MODIFIED
            if (!DateHelpers.isValid(joinDate) || !appState.config.monthlySalary) return; // MODIFIED

            let periodStart;
            let periodLabel = "";
            let salaryThisPeriod = 0;
            
            const effectiveSalary = getEffectiveMonthlySalary(now);
            const salaryCalc = calculateSalaryDetails(effectiveSalary);
            const salaryPerSecond = salaryCalc.perSecond;

            switch(appState.currentRealTimePeriod) {
                case 'today':
                    periodStart = DateHelpers.startOfToday(); // MODIFIED
                    periodLabel = "ä»Šæ—¥å·²èµš";
                    if (DateHelpers.isBefore(now, joinDate)) periodStart = joinDate; // MODIFIED
                    break;
                case 'week':
                    periodStart = DateHelpers.startOfWeek(now, true); // MODIFIED (true for Monday start)
                     periodLabel = "æœ¬å‘¨å·²èµš";
                    if (DateHelpers.isBefore(periodStart, joinDate)) periodStart = joinDate; // MODIFIED
                    break;
                case 'month':
                    periodStart = DateHelpers.startOfMonth(now); // MODIFIED
                     periodLabel = "æœ¬æœˆå·²èµš";
                    if (DateHelpers.isBefore(periodStart, joinDate)) periodStart = joinDate; // MODIFIED
                    break;
                case 'total':
                    periodStart = joinDate;
                     periodLabel = "ç´¯è®¡å·²èµš";
                    salaryThisPeriod = calculateTotalEarnedToDate(now);
                    break;
            }

            if (appState.currentRealTimePeriod !== 'total') {
                 if (DateHelpers.isAfter(now, periodStart) && salaryPerSecond > 0) { // MODIFIED
                    const secondsElapsed = DateHelpers.differenceInSeconds(now, periodStart); // MODIFIED
                    salaryThisPeriod = secondsElapsed * salaryPerSecond;
                 } else {
                    salaryThisPeriod = 0;
                 }
            }
             salaryThisPeriod = Math.max(0, salaryThisPeriod);

            animateNumber(DOMElements.realTimeSalaryAmount, salaryThisPeriod);
            DOMElements.realTimeSalaryLabel.textContent = periodLabel;
            
            if (DOMElements.fullscreenDisplay.classList.contains('hidden') === false) {
                 animateNumber(DOMElements.fullscreenSalaryAmount, salaryThisPeriod);
                 DOMElements.fullscreenSalaryLabel.textContent = periodLabel;
            }
        }
        
        function calculateTotalEarnedToDate(endDate = new Date()) {
            const joinDateObj = DateHelpers.parseISO(appState.config.joinDate); // MODIFIED
            if (!DateHelpers.isValid(joinDateObj) || DateHelpers.isAfter(joinDateObj, endDate)) return 0; // MODIFIED

            let totalEarned = 0;
            let currentDate = new Date(joinDateObj); 

            const sortedRaisePlan = appState.config.raisePlan && appState.config.raisePlan.length > 0 ?
                [...appState.config.raisePlan].sort((a, b) => DateHelpers.differenceInCalendarDays(DateHelpers.parseISO(a.date), DateHelpers.parseISO(b.date))) : []; // MODIFIED

            let currentRaiseIdx = 0;
            let nextRaiseDate = sortedRaisePlan.length > 0 ? DateHelpers.parseISO(sortedRaisePlan[0].date) : null; // MODIFIED

            while(DateHelpers.isBefore(currentDate, endDate)) { // MODIFIED
                let periodEndDate = endDate;
                if (nextRaiseDate && DateHelpers.isValid(nextRaiseDate) && DateHelpers.isBefore(nextRaiseDate, endDate)) { // MODIFIED
                    periodEndDate = nextRaiseDate;
                }

                const effectiveSalary = getEffectiveMonthlySalary(currentDate);
                const salaryCalc = calculateSalaryDetails(effectiveSalary);
                const salaryPerSecond = salaryCalc.perSecond;
                
                const secondsInPeriod = DateHelpers.differenceInSeconds(periodEndDate, currentDate); // MODIFIED
                totalEarned += secondsInPeriod * salaryPerSecond;
                
                currentDate = periodEndDate;

                if (nextRaiseDate && (DateHelpers.isEqual(currentDate, nextRaiseDate) || DateHelpers.isAfter(currentDate, nextRaiseDate))) { // MODIFIED
                    currentRaiseIdx++;
                    if (currentRaiseIdx < sortedRaisePlan.length) {
                        nextRaiseDate = DateHelpers.parseISO(sortedRaisePlan[currentRaiseIdx].date); // MODIFIED
                    } else {
                        nextRaiseDate = null; 
                    }
                }
                if (!nextRaiseDate && DateHelpers.isEqual(currentDate,endDate)) break; // MODIFIED
            }
            return Math.max(0, totalEarned);
        }


        // Data Persistence (loadState, saveConfig, saveRecords remain mostly the same, but parsing needs adjustment)
        function loadState() {
            const storedConfig = localStorage.getItem(LS_CONFIG_KEY);
            if (storedConfig) {
                appState.config = { ...appState.config, ...JSON.parse(storedConfig) };
                if (!Array.isArray(appState.config.raisePlan)) {
                    appState.config.raisePlan = [];
                }
                if (!appState.config.taxConfig) {
                    appState.config.taxConfig = { insuranceRate: 0.105, taxRate: 0.03 };
                }
            }
            const storedRecords = localStorage.getItem(LS_RECORDS_KEY);
            if (storedRecords) {
                appState.incomeRecords = JSON.parse(storedRecords);
            }
            // Ensure dates in records are YYYY-MM-DD strings
            appState.incomeRecords = appState.incomeRecords.map(r => ({
                ...r,
                date: DateHelpers.formatToYMD(DateHelpers.parseISO(r.date)) // MODIFIED
            }));
        }

        function saveConfig() {
            localStorage.setItem(LS_CONFIG_KEY, JSON.stringify(appState.config));
        }
        function saveRecords() {
            localStorage.setItem(LS_RECORDS_KEY, JSON.stringify(appState.incomeRecords));
        }

        // Daily Income Record
        function recordDailyIncome() {
            const todayStr = DateHelpers.formatToYMD(new Date()); // MODIFIED
            const todayDate = DateHelpers.parseISO(todayStr); // For comparisons
            const joinDate = DateHelpers.parseISO(appState.config.joinDate); // MODIFIED
            
            if (!DateHelpers.isValid(joinDate) || DateHelpers.isBefore(todayDate, joinDate) || !appState.config.monthlySalary) { // MODIFIED
                console.log("Not recording: Pre-join date or no salary set.");
                return;
            }

            const lastRecord = appState.incomeRecords.length > 0 ? appState.incomeRecords[appState.incomeRecords.length - 1] : null;
            let startDateToRecord = lastRecord ? DateHelpers.addDays(DateHelpers.parseISO(lastRecord.date), 1) : joinDate; // MODIFIED
            
            // Ensure startDateToRecord is not before joinDate
            if (DateHelpers.isBefore(startDateToRecord, joinDate)) {
                startDateToRecord = new Date(joinDate); // Use a new Date object from joinDate
            }

            let loopDate = new Date(startDateToRecord); // Use a new Date object to avoid modifying startDateToRecord

            // Loop up to and including today
            while (DateHelpers.isBefore(loopDate, todayDate) || DateHelpers.isSameDay(loopDate, todayDate)) { // MODIFIED
                const loopDateStr = DateHelpers.formatToYMD(loopDate); // MODIFIED
                
                // Check if already recorded for this day
                if (appState.incomeRecords.find(r => r.date === loopDateStr)) {
                    loopDate = DateHelpers.addDays(loopDate, 1); // MODIFIED
                    continue;
                }

                // Skip if loopDate is in the future (should not happen with the while condition but good for safety)
                if (DateHelpers.isAfter(loopDate, todayDate)) break; // MODIFIED

                const effectiveSalaryOnLoopDate = getEffectiveMonthlySalary(loopDate);
                const dailyDetails = calculateSalaryDetails(effectiveSalaryOnLoopDate);
                let incomeForLoopDate = dailyDetails.daily;
                
                if (incomeForLoopDate > 0) {
                    appState.incomeRecords.push({ date: loopDateStr, income: incomeForLoopDate });
                    console.log(`Recorded income for ${loopDateStr}: ${formatCurrency(incomeForLoopDate)}`);
                }
                loopDate = DateHelpers.addDays(loopDate, 1); // MODIFIED
            }
            appState.incomeRecords.sort((a,b) => DateHelpers.differenceInCalendarDays(DateHelpers.parseISO(a.date), DateHelpers.parseISO(b.date))); // MODIFIED
            saveRecords();
        }


        // UI Update Functions
        function updateOverviewStats() {
            const joinDate = DateHelpers.parseISO(appState.config.joinDate); // MODIFIED
            if (!DateHelpers.isValid(joinDate) || !appState.config.monthlySalary) { // MODIFIED
                DOMElements.totalEarned.textContent = "0.00";
                DOMElements.workDaysTotal.textContent = "0";
                DOMElements.avgDailyIncome.textContent = "0.00";
                DOMElements.encouragementText.textContent = "è¯·å…ˆè®¾ç½®æ‚¨çš„å·¥èµ„ä¿¡æ¯ã€‚";
                return;
            }

            const totalEarnedCumulative = calculateTotalEarnedToDate(new Date());
            animateNumber(DOMElements.totalEarned, totalEarnedCumulative);

            const daysWorked = DateHelpers.differenceInCalendarDays(new Date(), joinDate) + 1; // MODIFIED
            DOMElements.workDaysTotal.textContent = Math.max(0, daysWorked);

            const avgDaily = appState.incomeRecords.length > 0 ?
                (appState.incomeRecords.reduce((sum, r) => sum + r.income, 0) / appState.incomeRecords.length) :
                (totalEarnedCumulative > 0 && daysWorked > 0 ? totalEarnedCumulative / daysWorked : 0);
            animateNumber(DOMElements.avgDailyIncome, avgDaily);
            
            DOMElements.encouragementText.textContent = `å¤ªæ£’äº†ï¼æ‚¨å·²ç»æ‰“å·¥ ${daysWorked} å¤©ï¼Œå…±èµšå– ${formatCurrency(totalEarnedCumulative)} å…ƒï¼ç»§ç»­åŠ æ²¹ï¼`;
        }

        function renderCharts() {
            if (appState.incomeChartInstance) {
                appState.incomeChartInstance.destroy();
            }
            const chartType = DOMElements.chartTypeSelect.value;
            DOMElements.chartRangeSelect.style.display = chartType === 'history' ? 'inline-block' : 'none';
            DOMElements.chartRangeLabel.style.display = chartType === 'history' ? 'inline-block' : 'none';

            let chartData = { /* ... chartData structure remains same ... */ 
                labels: [],
                datasets: [{
                    label: 'æ”¶å…¥',
                    data: [],
                    borderColor: 'var(--primary-color)',
                    backgroundColor: 'rgba(74, 144, 226, 0.2)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: 'var(--primary-color)'
                }]
            };
            let chartOptions = { /* ... chartOptions structure remains same ... */ 
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: 'var(--text-color)' },
                        grid: { color: 'var(--border-color)' }
                    },
                    x: {
                        ticks: { color: 'var(--text-color)' },
                        grid: { color: 'var(--border-color)' }
                    }
                },
                plugins: {
                    legend: { labels: { color: 'var(--text-color)' } }
                }
            };

            if (chartType === 'history') {
                chartData.datasets[0].label = 'æ¯æ—¥ç´¯è®¡æ”¶å…¥';
                const range = DOMElements.chartRangeSelect.value;
                let filteredRecords = [...appState.incomeRecords];
                const today = new Date();

                if (range !== 'all') {
                    let chartStartDate;
                    if (range === '7') chartStartDate = DateHelpers.subDays(today, 6); // MODIFIED
                    else if (range === '30') chartStartDate = DateHelpers.subDays(today, 29); // MODIFIED
                    else if (range === 'month') chartStartDate = DateHelpers.startOfMonth(today); // MODIFIED
                    else if (range === 'year') chartStartDate = DateHelpers.startOfYear(today); // MODIFIED
                    
                    filteredRecords = filteredRecords.filter(r => {
                        const recordDate = DateHelpers.parseISO(r.date); // MODIFIED
                        return DateHelpers.isValid(recordDate) && (DateHelpers.isAfter(recordDate, chartStartDate) || DateHelpers.isEqual(recordDate, chartStartDate) || DateHelpers.isSameDay(recordDate, chartStartDate)); // MODIFIED + isSameDay
                    });
                }
                
                let cumulativeIncome = 0;
                if (range !== 'all' && filteredRecords.length > 0 && appState.incomeRecords.length > 0) {
                    const firstDateInFilteredRange = DateHelpers.parseISO(filteredRecords[0].date); // MODIFIED
                    const recordsBeforeRange = appState.incomeRecords.filter(r => DateHelpers.isBefore(DateHelpers.parseISO(r.date), firstDateInFilteredRange)); // MODIFIED
                    cumulativeIncome = recordsBeforeRange.reduce((sum, rec) => sum + rec.income, 0);
                }


                chartData.labels = filteredRecords.map(r => DateHelpers.formatToMMDD(DateHelpers.parseISO(r.date))); // MODIFIED
                chartData.datasets[0].data = filteredRecords.map(r => {
                    cumulativeIncome += r.income;
                    return cumulativeIncome;
                });
                 if (chartData.datasets[0].data.length > 0) {
                    chartOptions.scales.y.beginAtZero = false;
                 }

            } else if (chartType === 'future') {
                chartData.datasets[0].label = 'æœªæ¥æ”¶å…¥é¢„ä¼° (ç´¯è®¡)';
                const periods = [
                    { label: 'å½“å‰', months: 0 },
                    { label: '+6æœˆ', months: 6 },
                    { label: '+1å¹´', months: 12 },
                    { label: '+2å¹´', months: 24 },
                ];
                
                const baseTotalEarned = calculateTotalEarnedToDate(new Date());
                let lastTotal = baseTotalEarned;

                for (const period of periods) {
                    chartData.labels.push(period.label);
                    if (period.months === 0) {
                        chartData.datasets[0].data.push(baseTotalEarned);
                        continue;
                    }

                    let futureDate = DateHelpers.addMonths(new Date(), period.months); // MODIFIED
                    let projectedGain = 0;
                    
                    let tempDate = new Date();
                    const sortedRaisePlan = appState.config.raisePlan && appState.config.raisePlan.length > 0 ?
                        [...appState.config.raisePlan].sort((a, b) => DateHelpers.differenceInCalendarDays(DateHelpers.parseISO(a.date), DateHelpers.parseISO(b.date))) : []; // MODIFIED
                    
                    let currentRaiseIdxFuture = 0;
                    while(currentRaiseIdxFuture < sortedRaisePlan.length && DateHelpers.isBefore(DateHelpers.parseISO(sortedRaisePlan[currentRaiseIdxFuture].date), tempDate)) { // MODIFIED
                        currentRaiseIdxFuture++;
                    }
                    let nextRaiseDateFuture = currentRaiseIdxFuture < sortedRaisePlan.length ? DateHelpers.parseISO(sortedRaisePlan[currentRaiseIdxFuture].date) : null; // MODIFIED


                    while(DateHelpers.isBefore(tempDate, futureDate)) { // MODIFIED
                        let periodEndDate = futureDate;
                        if (nextRaiseDateFuture && DateHelpers.isValid(nextRaiseDateFuture) && DateHelpers.isBefore(nextRaiseDateFuture, futureDate)) { // MODIFIED
                             periodEndDate = nextRaiseDateFuture;
                        }

                        const effectiveSalary = getEffectiveMonthlySalary(tempDate);
                        const salaryCalc = calculateSalaryDetails(effectiveSalary);
                        const salaryPerSecond = salaryCalc.perSecond;
                        
                        const secondsInPeriod = DateHelpers.differenceInSeconds(periodEndDate, tempDate); // MODIFIED
                        projectedGain += secondsInPeriod * salaryPerSecond;
                        
                        tempDate = periodEndDate;

                        if (nextRaiseDateFuture && (DateHelpers.isEqual(tempDate, nextRaiseDateFuture) || DateHelpers.isAfter(tempDate, nextRaiseDateFuture))) { // MODIFIED
                            currentRaiseIdxFuture++;
                            if (currentRaiseIdxFuture < sortedRaisePlan.length) {
                                nextRaiseDateFuture = DateHelpers.parseISO(sortedRaisePlan[currentRaiseIdxFuture].date); // MODIFIED
                            } else {
                                nextRaiseDateFuture = null;
                            }
                        }
                        if (!nextRaiseDateFuture && DateHelpers.isEqual(tempDate, futureDate)) break; // MODIFIED
                    }
                    lastTotal += projectedGain;
                    chartData.datasets[0].data.push(lastTotal);
                }
                 chartOptions.scales.y.beginAtZero = false;
            }

            appState.incomeChartInstance = new Chart(DOMElements.incomeChartCanvas, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });
        }

        function populateSettingsModal() {
            // ... this function doesn't directly use date-fns functions, remains the same
            // but ensure joinDateInput.value is in YYYY-MM-DD format which input type=date expects
            DOMElements.joinDateInput.value = appState.config.joinDate; // Should already be YYYY-MM-DD
            const isSalaryVisible = DOMElements.monthlySalaryInput.type === 'number';
            DOMElements.monthlySalaryInput.type = isSalaryVisible ? 'number' : 'password';
            DOMElements.monthlySalaryInput.value = appState.config.monthlySalary || '';
            DOMElements.showSalaryToggle.textContent = isSalaryVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';

            DOMElements.workDaysPerMonthInput.value = appState.config.workDaysPerMonth;
            DOMElements.workHoursPerDayInput.value = appState.config.workHoursPerDay;
            DOMElements.insuranceRateInput.value = (appState.config.taxConfig.insuranceRate * 100).toFixed(1);
            DOMElements.taxRateInput.value = (appState.config.taxConfig.taxRate * 100).toFixed(1);

            DOMElements.raisePlanContainer.innerHTML = ''; 
            (appState.config.raisePlan || []).forEach((plan, index) => {
                addRaisePlanInput(plan.date, plan.percentage, index);
            });
        }
        
        function addRaisePlanInput(dateVal = '', percentVal = '', index = -1) {
            // ... remains the same
            const itemDiv = document.createElement('div');
            itemDiv.className = 'raise-plan-item';
            const newIndex = (index === -1) ? DOMElements.raisePlanContainer.children.length : index;
            itemDiv.dataset.index = newIndex;

            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.value = dateVal;
            dateInput.className = 'raise-plan-date';
            
            const percentInput = document.createElement('input');
            percentInput.type = 'number';
            percentInput.placeholder = 'æ¶¨å¹… %';
            percentInput.value = percentVal;
            percentInput.className = 'raise-plan-percent';
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'ç§»é™¤';
            removeBtn.className = 'secondary';
            removeBtn.style.padding = '5px 10px';
            removeBtn.onclick = () => itemDiv.remove();
            
            itemDiv.appendChild(dateInput);
            itemDiv.appendChild(percentInput);
            itemDiv.appendChild(removeBtn);
            DOMElements.raisePlanContainer.appendChild(itemDiv);
        }

        function saveSettingsFromModal() {
            appState.config.joinDate = DOMElements.joinDateInput.value || DateHelpers.formatToYMD(new Date()); // MODIFIED
            appState.config.monthlySalary = parseFloat(DOMElements.monthlySalaryInput.value) || 0;
            appState.config.workDaysPerMonth = parseInt(DOMElements.workDaysPerMonthInput.value) || 22;
            appState.config.workHoursPerDay = parseInt(DOMElements.workHoursPerDayInput.value) || 8;
            appState.config.taxConfig.insuranceRate = (parseFloat(DOMElements.insuranceRateInput.value) / 100) || 0;
            appState.config.taxConfig.taxRate = (parseFloat(DOMElements.taxRateInput.value) / 100) || 0;

            appState.config.raisePlan = [];
            $$('#raisePlanContainer .raise-plan-item').forEach(item => {
                const date = item.querySelector('.raise-plan-date').value; // This is YYYY-MM-DD
                const percentage = parseFloat(item.querySelector('.raise-plan-percent').value);
                if (date && !isNaN(percentage)) {
                    appState.config.raisePlan.push({ date, percentage });
                }
            });
            appState.config.raisePlan.sort((a,b) => DateHelpers.differenceInCalendarDays(DateHelpers.parseISO(a.date), DateHelpers.parseISO(b.date))); // MODIFIED

            saveConfig();
            DOMElements.settingsModal.style.display = 'none';
            recordDailyIncome();
            updateAllDisplays();
        }
        
        function updateAllDisplays() { /* ... remains same ... */ 
            updateRealTimeClock(); 
            updateOverviewStats();
            renderCharts();
            updateTaxButtonText();
        }

        function updateTaxButtonText() { /* ... remains same ... */ 
            DOMElements.toggleTaxBtn.textContent = appState.config.isAfterTax ? 'ç¨å (ç‚¹å‡»åˆ‡æ¢ç¨å‰)' : 'ç¨å‰ (ç‚¹å‡»åˆ‡æ¢ç¨å)';
        }

        // Event Listeners Setup (remains the same)
        function setupEventListeners() {
            DOMElements.settingsBtn.onclick = () => {
                populateSettingsModal();
                DOMElements.settingsModal.style.display = 'block';
            };
            DOMElements.modalCloseBtn.onclick = () => DOMElements.settingsModal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == DOMElements.settingsModal) {
                    DOMElements.settingsModal.style.display = 'none';
                }
            };
            DOMElements.saveSettingsBtn.onclick = saveSettingsFromModal;
            DOMElements.addRaisePlanBtn.onclick = () => addRaisePlanInput();
            
            DOMElements.showSalaryToggle.onclick = () => {
                const input = DOMElements.monthlySalaryInput;
                if (input.type === 'password') {
                    input.type = 'number';
                    DOMElements.showSalaryToggle.textContent = 'ğŸ™ˆ';
                } else {
                    input.type = 'password';
                    DOMElements.showSalaryToggle.textContent = 'ğŸ‘ï¸';
                }
            };

            DOMElements.toggleTaxBtn.onclick = () => {
                appState.config.isAfterTax = !appState.config.isAfterTax;
                saveConfig();
                updateAllDisplays();
            };

            DOMElements.toggleThemeBtn.onclick = () => {
                document.body.classList.toggle('dark-mode');
                DOMElements.toggleThemeBtn.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸ æ—¥é—´æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
                renderCharts(); 
            };

            DOMElements.realTimePeriodButtons.forEach(button => {
                button.onclick = () => {
                    appState.currentRealTimePeriod = button.dataset.period;
                    updateRealTimeClock();
                };
            });

            DOMElements.fullscreenBtn.onclick = () => {
                DOMElements.fullscreenDisplay.classList.remove('hidden');
                DOMElements.appContainer.classList.add('hidden');
                updateRealTimeClock();
            };
            DOMElements.fullscreenExitBtn.onclick = () => {
                DOMElements.fullscreenDisplay.classList.add('hidden');
                DOMElements.appContainer.classList.remove('hidden');
            };
            
            DOMElements.chartTypeSelect.onchange = renderCharts;
            DOMElements.chartRangeSelect.onchange = renderCharts;

            DOMElements.exportCsvBtn.onclick = exportDataToCSV;
        }

        function exportDataToCSV() { /* ... remains same ... */ 
            if (appState.incomeRecords.length === 0) {
                alert("æ²¡æœ‰å†å²æ•°æ®å¯ä»¥å¯¼å‡ºã€‚");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,Date,Income\n";
            appState.incomeRecords.forEach(record => {
                csvContent += `${record.date},${formatCurrency(record.income)}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "working_clock_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialization
        function init() {
            loadState();
            
            DOMElements.monthlySalaryInput.type = 'password';
            DOMElements.showSalaryToggle.textContent = 'ğŸ‘ï¸';

            DOMElements.currentYear.textContent = new Date().getFullYear();
            
            recordDailyIncome(); 
            
            updateAllDisplays();
            
            setupEventListeners();

            if (appState.realTimeInterval) clearInterval(appState.realTimeInterval);
            appState.realTimeInterval = setInterval(updateRealTimeClock, 1000);

            renderCharts(); 

            if (!appState.config.monthlySalary || appState.config.monthlySalary === 0) {
                 setTimeout(() => { 
                    DOMElements.settingsModal.style.display = 'block';
                    populateSettingsModal();
                    alert("æ¬¢è¿ä½¿ç”¨ WorkingClock! è¯·å…ˆå®ŒæˆåŸºæœ¬è®¾ç½®ã€‚");
                }, 500);
            }
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>